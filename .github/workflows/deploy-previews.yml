name: Deploy previews (branches + PRs)

on:
  push:
    branches-ignore:
      - main
      - staging
  pull_request:
    branches:
      - main
      - staging

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  preview:
    # Run for pushes (always same repo). For PRs, skip forks (no secrets).
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Always point the bundle at STAGING services for previews
      - name: Use staging Firebase config
        run: cp scripts/config.staging.js scripts/config.js

      # ---- Branch pushes -> explicit channel per branch ----
      - name: Compute preview channel id
        if: github.event_name == 'push'
        run: |
          # preview-<branch>, lowercase, non-alnum -> '-'
          CID="preview-$(echo '${GITHUB_REF_NAME}' | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g' | sed -E 's/^-+|-+$//g')"
          echo "CHANNEL_ID=$CID" >> $GITHUB_ENV

      - name: Deploy preview (branch push)
        if: github.event_name == 'push'
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_STAGING }}
          projectId: srikar-book-deals-staging
          channelId: ${{ env.CHANNEL_ID }}
          expires: 7d

      # ---- PRs -> Firebase auto-names channel (pr-<number>) ----
      - name: Deploy preview (pull request)
        if: github.event_name == 'pull_request'
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_STAGING }}
          projectId: srikar-book-deals-staging
          expires: 7d
