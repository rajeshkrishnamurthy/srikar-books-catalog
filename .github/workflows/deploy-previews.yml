name: Deploy previews (branches + PRs)

on:
  push:
    branches-ignore:
      - main
      - staging
  pull_request:
    branches:
      - main
      - staging

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  preview:
    # Run for pushes (always same repo). For PRs, skip forks (no secrets).
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Always point the bundle at STAGING services for previews
      - name: Use staging Firebase config
        run: cp scripts/config.staging.js scripts/config.js

      # ---- Branch pushes -> explicit channel per branch ----
      - name: Compute preview channel id (max 32 chars incl. prefix)
        if: github.event_name == 'push'
        run: |
          REF="${{ github.head_ref || github.ref_name }}"
          # Sanitize branch: lowercase, replace non [a-z0-9] with '-', trim '-'
          SAFE=$(echo "$REF" | tr '[:upper:]' '[:lower:]' \
                 | sed -E 's/[^a-z0-9]+/-/g' | sed -E 's/^-+|-+$//g')
          # Limit suffix to 24 chars so "preview-" + suffix stays within 32 chars
          PART=$(echo "$SAFE" | cut -c1-24)
          [ -z "$PART" ] && PART="branch"
          echo "CHANNEL_ID=preview-$PART" >> $GITHUB_ENV

      - name: Deploy preview (branch push)
        if: github.event_name == 'push'
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_STAGING }}
          projectId: srikar-book-deals-staging
          channelId: ${{ env.CHANNEL_ID }}
          expires: 7d

      # ---- PRs -> Firebase auto-names channel (pr-<number>) ----
      - name: Deploy preview (pull request)
        if: github.event_name == 'pull_request'
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_STAGING }}
          projectId: srikar-book-deals-staging
          expires: 7d
