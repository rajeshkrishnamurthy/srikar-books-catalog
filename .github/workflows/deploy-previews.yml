name: Deploy previews (branches + PRs)

on:
  push:
    branches-ignore:
      - main
  pull_request:

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  preview:
    # Fork‑safety guard: don’t try to use secrets on PRs from forks
    if: ${{ github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Build step: keep if you add a bundler later; for pure static leave as noop
      - name: Build (static site)
        run: echo "No build step"

      # Make a safe channel id from the branch name (lowercase, [a-z0-9-], max 40)
      - name: Compute channel id
        run: |
          REF="${{ github.head_ref || github.ref_name }}"
          CHID=$(echo "$REF" | tr '[:upper:]' '[:lower:]' | tr -c 'a-z0-9-' '-' | sed 's/^-*//;s/-*$//' | cut -c1-40)
          echo "CHANNEL_ID=preview-$CHID" >> $GITHUB_ENV

      # Deploy preview to the STAGING Firebase project
      - name: Deploy to Firebase Hosting (preview channel)
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_STAGING }}
          projectId: srikar-book-deals-staging
          channelId: ${{ env.CHANNEL_ID }}
