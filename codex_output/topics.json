{
  "feature": "Admin Purchase Price Handling",
  "topics": [
    {
      "id": "TP1",
      "title": "Capture Purchase Price on Add",
      "area": "Admin / Inventory Form",
      "goal": "Allow admins to enter and persist a purchase price when creating a book record.",
      "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
      "dependencies": [],
      "given": "An authenticated admin opens the Add Book form.",
      "when": "They enter a numeric purchase price and submit the form.",
      "then": "The value is validated (required, non-negative) and written to Firestore with the new book.",
      "notes": "Includes schema update, client-side validation messaging, and serverTimestamp-safe writes."
    },
    {
      "id": "TP2",
      "title": "Edit Stored Purchase Price",
      "area": "Admin / Inventory Management",
      "goal": "Enable admins to adjust the saved purchase price on existing books without recreating them.",
      "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
      "dependencies": ["TP1"],
      "given": "A book exists in inventory with or without a purchase price set.",
      "when": "An admin invokes the edit action and updates the purchase price field.",
      "then": "The new value passes validation and updates the Firestore document, reflecting immediately in the UI.",
      "notes": "Guard against empty submissions; reuse validation logic from TP1; keep optimistic UI updates consistent."
    },
    {
      "id": "TP3",
      "title": "Admin Visibility of Purchase Price",
      "area": "Admin / Inventory List",
      "goal": "Surface each book's purchase price to admins within list/detail panels for quick reference.",
      "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
      "dependencies": ["TP1"],
      "given": "An admin loads the inventory dashboard or detail drawer.",
      "when": "Books are rendered in the admin UI.",
      "then": "Each entry shows the stored purchase price (formatted currency or placeholder when missing) without affecting actions.",
      "notes": "Ensure formatting is locale-aware and accessible; no exposure in public components."
    },
    {
      "id": "TP4",
      "title": "Hide Purchase Price from Public Catalog",
      "area": "Public Catalog / Data Privacy",
      "goal": "Guarantee purchase price data never appears in the public catalog payloads or UI.",
      "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
      "dependencies": ["TP1"],
      "given": "A visitor browses the public catalog.",
      "when": "Client-side code queries Firestore and renders cards.",
      "then": "Purchase price fields are omitted or stripped before rendering so no cost data leaks publicly.",
      "notes": "Double-check Firestore queries/selects and DOM templates; consider security rules to block reads from non-admin contexts."
    }
  ],
  "features": [
    {
      "featureId": "F05",
      "featureTitle": "Supplier Master Management",
      "description": "Introduce a supplier master so admins can CRUD suppliers (Name, Location) and keep every book attached to a supplier.",
      "topics": [
        {
          "id": "F05-TP1",
          "title": "Create Supplier Records",
          "area": "Admin / Supplier Master",
          "goal": "Allow admins to add supplier entries with required name and location data.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": [],
          "given": "An admin opens the Supplier Master view.",
          "when": "They submit the form with a supplier name and location.",
          "then": "A new supplier document is persisted and listed without duplicates.",
          "notes": "Surface inline validation for required fields and prevent duplicate supplier names."
        },
        {
          "id": "F05-TP2",
          "title": "Edit or Remove Supplier Records",
          "area": "Admin / Supplier Master",
          "goal": "Let admins update supplier details or remove suppliers that are no longer in use.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": ["F05-TP1"],
          "given": "A supplier exists in the master list.",
          "when": "An admin edits the name/location or requests deletion.",
          "then": "Changes persist with audit safety, and deletions are blocked if books still reference the supplier.",
          "notes": "Show dependency warnings for in-use suppliers and ensure local lists stay in sync after edits."
        },
        {
          "id": "F05-TP3",
          "title": "Attach Supplier on Book Creation",
          "area": "Admin / Catalog",
          "goal": "Require selecting an existing supplier whenever a new book is created.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": ["F05-TP1"],
          "given": "An admin is creating a book and the supplier master already contains at least one active supplier.",
          "when": "They select a supplier from the dropdown (or attempt to submit without a selection) and submit the book form.",
          "then": "Valid submissions persist the supplier reference with the book, while missing/invalid selections block the save with clear feedback.",
          "notes": "Sync the supplier list in real time, prevent stale selections when a supplier is deleted mid-session, and support keyboard navigation for the control."
        },
        {
          "id": "F05-TP4",
          "title": "Edit Book-Supplier Mapping",
          "area": "Admin / Catalog",
          "goal": "Enable admins to change the supplier linked to an existing book.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": ["F05-TP3"],
          "given": "A book already has a supplier association.",
          "when": "An admin selects a different supplier and confirms the edit.",
          "then": "The book document updates with the new supplier, and all admin views refresh to reflect the change.",
          "notes": "Prevent orphan mappings by validating the new supplier still exists; broadcast updates to caching layers if any."
        }
      ]
    },
    {
      "featureId": "F06",
      "featureTitle": "Book Sale Settlement",
      "description": "Capture the complete sale outcome for each book, including sale price, inventory status, partner payout shares, and buyer attribution.",
      "topics": [
        {
          "id": "F06-TP1",
          "title": "Record Sale Status and Price",
          "area": "Admin / Sales Workflow",
          "goal": "Let admins toggle in-stock vs sold-out and capture the final sale price in a single action.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": [],
          "given": "A book exists in the catalog and is ready to be marked as sold.",
          "when": "The admin switches the sale status and enters a sale price before saving.",
          "then": "The book document stores the status flag plus a validated sale price (required when sold, optional when still in stock).",
          "notes": "Enforce positive currency values, prevent marking as sold without a price, and update stock counters in the UI after persistence."
        },
        {
          "id": "F06-TP2",
          "title": "Compute Revenue Shares",
          "area": "Admin / Settlement",
          "goal": "Automatically calculate Srikar's share and the supplier share using sale and cost prices.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": ["TP1", "F06-TP1"],
          "given": "The book already stores a cost price and the sale workflow captured a sale price.",
          "when": "The admin confirms the sale.",
          "then": "Srikar's share is recorded as (sale price - cost price)/2 and supplier share as cost price + (sale price - cost price)/2 with consistent rounding rules.",
          "notes": "Guard against sale prices lower than cost, surface computed amounts before commit, and reuse currency-format helpers to keep reports consistent."
        },
        {
          "id": "F06-TP3",
          "title": "Associate Buyer With Sale",
          "area": "Admin / Sales Workflow",
          "goal": "Link each sold book to a buyer drawn from the customer master so downstream reports know who purchased it.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": ["F06-TP1", "F07-TP1"],
          "given": "Customer records exist and a book is being marked as sold.",
          "when": "The admin searches for and selects a buyer (or adds one on the fly) within the sale confirmation flow.",
          "then": "The sale record stores the buyer reference and displays it anywhere the sale appears (history, settlements, receipts).",
          "notes": "Selection should be mandatory for sold books, support search by name/WhatsApp, and prevent orphaned references if the customer later changes."
        }
      ]
    },
    {
      "featureId": "F07",
      "featureTitle": "Customer Master Management",
      "description": "Introduce a lightweight customer directory with add/edit flows that capture name, address, location, and WhatsApp number for reuse in sales.",
      "topics": [
        {
          "id": "F07-TP1",
          "title": "Add Customer Records",
          "area": "Admin / Customer Master",
          "goal": "Allow admins to create customers with the required contact fields so that buyers can be tracked.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": [],
          "given": "An admin opens the Customer Master module.",
          "when": "They submit the add form with name, address, location, and WhatsApp number.",
          "then": "A validated customer document is stored with normalized phone data and timestamps.",
          "notes": "Deduplicate by name + WhatsApp, enforce number formatting, and show inline errors for missing required fields."
        },
        {
          "id": "F07-TP2",
          "title": "Edit Customer Records",
          "area": "Admin / Customer Master",
          "goal": "Let admins update customer details without breaking links to past sales.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": ["F07-TP1"],
          "given": "A customer already exists in the directory.",
          "when": "An admin opens the record and amends the address, location, or WhatsApp info.",
          "then": "Changes persist, update the modified timestamp, and propagate to any sale views that reference the customer.",
          "notes": "Prevent edits that clear required fields, highlight unsaved changes, and keep references stable via immutable IDs."
        },
        {
          "id": "F07-TP3",
          "title": "Customer Lookup for Sales",
          "area": "Admin / Customer Master",
          "goal": "Expose a searchable customer list so other workflows (like sales settlement) can pick buyers quickly.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": ["F07-TP1"],
          "given": "An admin opens the customer lookup without any filter applied.",
          "when": "They enter a search term (e.g., name or WhatsApp) and submit/filter.",
          "then": "Until text is entered the list stays empty with guidance; once a query is provided, only matching customer summaries (name, location, WhatsApp) appear and the selected customer ID is emitted back to the calling workflow.",
          "notes": "Keep the pre-search state blank with helper text, require at least a few characters before querying, provide debounced search, highlight exact matches, and coordinate with F06-TP3 so a single selection UI can serve multiple modules."
        }
      ]
    },
    {
      "featureId": "F08",
      "featureTitle": "Sales Entry Management",
      "description": "Enable admins to record multi-item sales with customer attribution, per-book pricing, and consistent inventory status labels.",
      "topics": [
        {
          "id": "F08-TP1",
          "title": "Capture Sale Header",
          "area": "Admin / Sales Entry",
          "goal": "Require selecting a customer and sale date before adding sold books.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": ["F07-TP1"],
          "given": "An admin opens the Add Sale workflow and customer records already exist.",
          "when": "They search for a buyer and choose a sale date prior to saving.",
          "then": "The sale form locks in the selected customer ID and sale date, blocking continuation until both values pass validation.",
          "notes": "Surface inline errors for missing selections, support calendar pickers plus manual entry, and store timestamps in UTC."
        },
        {
          "id": "F08-TP2",
          "title": "Add Sale Line Items",
          "area": "Admin / Sales Entry",
          "goal": "Allow admins to add one line per book sold, capturing title, supplier, and selling price.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": ["TP1", "F05-TP3", "F06-TP1"],
          "given": "The sale header is valid and the catalog already tracks purchase prices, suppliers, and stock.",
          "when": "The admin searches for a book, selects it (possibly multiple times for separate quantities), and enters a selling price for each line.",
          "then": "Each line stores the book reference, supplier snapshot, and validated selling price while allowing duplicate book entries to represent multiple quantities.",
          "notes": "Prevent mixing draft lines with missing prices, auto-populate supplier info when a book is chosen, and show running totals."
        },
        {
          "id": "F08-TP3",
          "title": "Persist Sale and Align UI Copy",
          "area": "Admin / Sales Entry",
          "goal": "Save the sale record and ensure the legacy 'Mark as Sold' button now reads 'Out of stock'.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": ["F08-TP1", "F08-TP2"],
          "given": "All sale header and line item validations pass.",
          "when": "The admin submits the sale.",
          "then": "A sale document containing the header and all line items is persisted, and every instance of the old 'Mark as Sold' button label is updated to 'Out of stock' without changing inventory automatically.",
          "notes": "Delay automatic stock flips until inventory rules mature; still show per-line persistence status and keep the new label consistent across the admin UI."
        }
      ]
    },
    {
      "featureId": "F09",
      "featureTitle": "Title-Based Sale Line Entry",
      "description": "Streamline sale line creation by letting admins search by book title, auto-fill supplier/price context, and manage the draft row without extra inventory lookups.",
      "topics": [
        {
          "id": "F09-TP1",
          "title": "Title Autocomplete Experience",
          "area": "Admin / Sales Entry",
          "goal": "Make the sale line title picker visually rich with card-style suggestions, keyboard navigation, and clear post-selection feedback.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": ["F08-TP2"],
          "given": "An admin is adding a sale line and catalog titles exist.",
          "when": "They type into the Book title field and move through the suggestion list via mouse or keyboard.",
          "then": "Each suggestion renders as a clickable card showing title, author, supplier badges, and a caret; hover/focus states highlight the option, the active item exposes aria-selected=\"true\", selecting a book shows a confirmation chip under #saleLineBookSummary, clears the list with a “Book selected” toast near #saleLineMsg, moves focus to the selling-price field, and no-match scenarios keep the line disabled with the guidance message.",
          "notes": "Use the title-only search, add solid backgrounds plus outline for the focused item, support ESC to dismiss, and announce the number of matches for assistive tech."
        },
        {
          "id": "F09-TP3",
          "title": "Header CTA and Draft Flow Alignment",
          "area": "Admin / Sales Entry",
          "goal": "Rename the header CTA, gate book entry until customer/date validate, and keep the draft row messaging in sync with the current selection.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": ["F08-TP1", "F09-TP1"],
          "given": "The sale header form is visible inside the sale entry experience.",
          "when": "The admin interacts with the header (selecting customer/date, pressing the CTA) or selects a book for the draft line.",
          "then": "The primary CTA reads “Add books” (beside a disabled Persist sale button) with helper text “Customer + date unlocks book entry,” stays disabled until both fields validate, and on success silently resets the form without extra banners; the draft label stays “Add another book,” while focus hops to the price field after a selection and returns to the book input once the line saves.",
          "notes": "Keep helper copy inline beneath the CTA, briefly show a success state on the CTA before re-enabling, and ensure keyboard users perceive the label changes."
        },
        {
          "id": "F09-TP4",
          "title": "Customer Selection Feedback",
          "area": "Admin / Sales Entry",
          "goal": "Provide visible confirmation when a buyer is selected from the lookup list and mirror the state in the summary pill.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": ["F07-TP3", "F08-TP1"],
          "given": "An admin is choosing a customer via the lookup list inside the sale header.",
          "when": "They click Select on a customer and the hidden ID updates successfully.",
          "then": "The chosen row highlights with a filled background and the Select button becomes a checkmark chip labeled “Selected,” while #saleHeaderCustomerSummary swaps in the customer name, WhatsApp, city, and a “Change customer” text button that animates into view.",
          "notes": "Keep the state persistent after closing the lookup, announce the selection change for assistive tech, and allow re-selecting another customer which clears the prior highlight."
        },
        {
          "id": "F09-TP5",
          "title": "Persistent Customer Selection",
          "area": "Admin / Sales Entry",
          "goal": "Ensure a chosen customer remains selected even if the lookup input is cleared, only changing when a new customer is picked.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": ["F09-TP4"],
          "given": "An admin has successfully selected a customer and sees the summary pill populated.",
          "when": "They clear the lookup search field or type a new string without confirming another customer.",
          "then": "The previously selected customer stays locked in (highlight + summary pill intact) until another customer is explicitly selected, with an optional clear-selection control to reset the state.",
          "notes": "Debounce search input reset so it never wipes the stored selection, show a subtle notice that a customer is already selected, and require an explicit 'Change customer' action before replacing the selection."
        },
        {
          "id": "F09-TP6",
          "title": "Sale Panel Access and Visual Hierarchy",
          "area": "Admin / Inventory Header",
          "goal": "Add a primary Record sale entry point and restyle the sale panel with elevated inputs, sticky sections, and informative empty states.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": ["F08-TP1", "F09-TP1"],
          "given": "An authenticated admin is on admin.html with the inventory header (search + actions) visible.",
          "when": "They click the Record sale button beside the search box.",
          "then": "The button (matching other primary actions) scroll-focuses or opens the sale panel/modal, #saleEntryPanel inputs use a raised token with lighter background plus outline/glow focus states, sticky section headers keep the sale header and line form separated, and concise empty-state hints clarify what totals or metadata will appear after books are added.",
          "notes": "Ensure the Record sale action is one tap away on desktop/mobile, trap focus inside the modal when open, keep the panel visible by default for keyboard access, and provide the “Customer + date unlocks book entry” reminder near the CTA."
        },
        {
          "id": "F09-TP7",
          "title": "Clear Lookup After Selection",
          "area": "Admin / Sales Entry",
          "goal": "Automatically reset the customer search field and collapse results after a customer is selected.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": ["F09-TP4", "F09-TP5"],
          "given": "A customer selection succeeds and the summary pill shows the chosen buyer.",
          "when": "The selection confirmation event fires (button press or keyboard action).",
          "then": "The lookup input clears its text, the autocomplete results list disappears, focus shifts to the next logical control (e.g., sale date), and the previously selected customer remains locked in until Change customer is invoked.",
          "notes": "Announce the reset for assistive tech, prevent accidental clearing if selection fails, and re-open the search automatically when Change customer is pressed."
        },
        {
          "id": "F09-TP8",
          "title": "Selling Price Input Guardrails",
          "area": "Admin / Sales Entry",
          "goal": "Restrict the selling price field to numeric entry with immediate validation feedback.",
          "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
          "dependencies": ["F08-TP2"],
          "given": "An admin is entering a selling price for a sale line.",
          "when": "They type characters into the selling price input or attempt to submit a non-numeric/negative value.",
          "then": "Only digits (and a single optional decimal separator) are accepted, invalid keystrokes are ignored, and inline validation explains that the selling price must be a positive number before the line can be saved.",
          "notes": "Reuse existing currency-validation helpers, keep keyboard navigation (Tab, Backspace) functional, and announce validation errors to assistive tech users."
        }
      ]
    }
  ]
}
