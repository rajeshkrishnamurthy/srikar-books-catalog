{
  "topicId": "F11-TP2",
  "title": "Remove Line and Recalculate Draft State",
  "area": "Admin / Sales Entry",
  "goal": "When removal is confirmed, delete the line from local state, update totals, clear draft state, and keep focus ready for the next entry.",
  "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
  "status": "GREEN",
  "specs": [
    {
      "id": "F11-TP2-001",
      "title": "ConfirmRemovalDeletesRow",
      "given": "At least two sale lines exist and the header is ready.",
      "when": "An admin clicks the Remove control twice (remove + confirm) for a specific row.",
      "then": "That row disappears from `#saleLineItemsBody`, `getLines()` no longer includes the lineId, and the inline status list logs a message such as “Removed Astrophysics 101 from sale”.",
      "test": "/tests/spec/admin/F11-TP2-001_ConfirmRemovalDeletesRow.spec.js"
    },
    {
      "id": "F11-TP2-002",
      "title": "TotalsRecalculateAfterRemoval",
      "given": "Multiple lines with different prices exist.",
      "when": "One line is removed via the confirm step.",
      "then": "The totals count/amount elements (`#saleLineTotalsCount`, `#saleLineTotalsAmount`) recompute immediately and match the remaining lines’ sum.",
      "test": "/tests/spec/admin/F11-TP2-002_TotalsRecalculateAfterRemoval.spec.js"
    },
    {
      "id": "F11-TP2-003",
      "title": "FinalRemovalResetsDraft",
      "given": "Exactly one line remains and the admin confirms its removal.",
      "when": "The confirmation completes.",
      "then": "The draft form resets: supplier select clears, book summary reverts to the default, the draft label shows “Add another book”, focus returns to the book title input, and the Persist sale button becomes disabled because no lines exist.",
      "test": "/tests/spec/admin/F11-TP2-003_FinalRemovalResetsDraft.spec.js"
    }
  ],
  "fixtures": [
    "/tests/fixtures/salesLineItemsHarness.js",
    "/tests/fixtures/salesEntryPersistHarness.js"
  ],
  "reports": {
    "red": "codex_output/reports/F11-TP2_red.txt",
    "green": "codex_output/reports/F11-TP2_green.txt"
  },
  "validation": {
    "status": "GREEN",
    "command": "npm test -- --watchAll=false --bail=0",
    "report": "codex_output/reports/F11-TP2_green.txt",
    "summary": {
      "result": "passed",
      "details": "Confirmed removal now deletes the row, recalculates totals, logs status updates, and resets the draft/persist state after the final line."
    }
  },
  "changedFiles": [
    "admin.html",
    "scripts/admin/main.js",
    "scripts/admin/salesLineItems.js",
    "tests/fixtures/adminInventoryHarness.js",
    "tests/fixtures/salesLineItemsHarness.js",
    "codex_output/reports/F11-TP2_green.txt",
    "codex_output/specs/F11-TP2.json"
  ],
  "changeNotes": [
    "Embedded the removal status live region and wired the sale line module to log removals, update totals, and disable Persist sale when the last line is deleted.",
    "Updated the sales line harness + main wiring to pass the new search + status nodes so the Jest specs can observe removal state transitions."
  ],
  "notes": "These specs build on F11-TP1: Remove buttons already exist—F11-TP2 enforces the data/state updates once a removal is confirmed."
}
