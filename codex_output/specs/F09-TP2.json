{
  "topicId": "F09-TP2",
  "title": "Auto-Fill Supplier and Price Context",
  "area": "Admin / Sales Entry",
  "goal": "Populate supplier snapshots plus historical selling/purchase price hints as soon as a title is selected.",
  "environment": "HTML + Vanilla JavaScript + Firebase + Jest + jsdom",
  "status": "GREEN",
  "specs": [
    {
      "id": "F09-TP2-001",
      "title": "ShowSupplierContext",
      "given": "A book with supplier metadata is chosen through the title autocomplete (F09-TP1).",
      "when": "The selection is applied to the sale line draft.",
      "then": "The supplier hint panel shows the supplier name + location immediately and marks the context as non-empty while the hidden bookId remains aligned with F08-TP2.",
      "test": "/tests/spec/admin/F09-TP2-001_SupplierContextPopulates.spec.js"
    },
    {
      "id": "F09-TP2-002",
      "title": "ShowHistoricalPriceHints",
      "given": "The selected book includes purchase price and last selling price history.",
      "when": "The hint module renders the context.",
      "then": "Purchase and last sold rows display currency-formatted values (₹) with descriptive labels so admins can price the new line quickly.",
      "test": "/tests/spec/admin/F09-TP2-002_ShowsHistoricalPriceHints.spec.js"
    },
    {
      "id": "F09-TP2-003",
      "title": "ClearHintsWhenSelectionClears",
      "given": "A supplier + price context is already shown.",
      "when": "The selection is cleared or replaced with null.",
      "then": "All hint rows reset to Not set, datasets flip back to empty=true, and no stale supplier/price data remains in the UI.",
      "test": "/tests/spec/admin/F09-TP2-003_ClearsHintsWhenSelectionClears.spec.js"
    },
    {
      "id": "F09-TP2-004",
      "title": "PreserveSupplierSnapshotOnSubmit",
      "given": "A supplier snapshot was auto-filled for the draft line.",
      "when": "The admin overrides hint text manually or changes prices before saving the line.",
      "then": "The persisted line payload still carries the supplier id/name/location captured at selection time and the DOM shows the new row, proving hints do not mutate the saved snapshot.",
      "test": "/tests/spec/admin/F09-TP2-004_ManualOverridesPreserveSupplier.spec.js"
    },
    {
      "id": "F09-TP2-005",
      "title": "FormatPriceHintHelper",
      "given": "Upstream helpers need to render friendly hint labels.",
      "when": "formatPriceHint is invoked with a label and amount (or missing amount).",
      "then": "It returns strings such as \"Last sold: ₹540\" and falls back to \"Not set\" when the amount is null/undefined, so the UI stays consistent.",
      "test": "/tests/unit/admin/F09-TP2-001_FormatPriceHint.test.js"
    },
    {
      "id": "F09-TP2-006",
      "title": "SupplierSelectPrefillsFromBook",
      "given": "A book with a supplier snapshot is selected.",
      "when": "The sale line draft renders the supplier dropdown.",
      "then": "The dropdown automatically selects the matching supplier option (while leaving other suppliers available) so the default is never blank.",
      "test": "/tests/spec/admin/F09-TP2-006_SupplierSelectPrefills.spec.js"
    },
    {
      "id": "F09-TP2-007",
      "title": "RequireSupplierSelectionAndAllowOverrides",
      "given": "Supplier selection must be captured for each sale line.",
      "when": "The admin clears the supplier dropdown or picks a different supplier.",
      "then": "Clearing the field disables Add line with an inline supplier error, while choosing another supplier persists that supplier snapshot in the payload.",
      "test": "/tests/spec/admin/F09-TP2-007_SupplierSelectionRequired.spec.js"
    }
  ],
  "fixtures": [
    "/tests/fixtures/salesLineItemsHarness.js"
  ],
  "reports": {
    "red": "codex_output/reports/F09-TP2_red.txt",
    "green": "codex_output/reports/F09-TP2_green.txt"
  },
  "validation": {
    "command": "npm test -- --watchAll=false --bail=0",
    "status": "GREEN",
    "report": "codex_output/reports/F09-TP2_green.txt",
    "summary": {
      "result": "passed",
      "details": "Supplier dropdown prefills, required validation, and override persistence verified alongside the existing hint specs (see codex_output/reports/F09-TP2_green.txt)."
    }
  },
  "changedFiles": [
    "admin.html",
    "scripts/admin/main.js",
    "scripts/admin/salesLineItems.js",
    "scripts/admin/salesLineHints.js",
    "tests/fixtures/salesLineItemsHarness.js",
    "tests/spec/admin/F09-TP2-001_SupplierContextPopulates.spec.js",
    "tests/spec/admin/F09-TP2-002_ShowsHistoricalPriceHints.spec.js",
    "tests/spec/admin/F09-TP2-003_ClearsHintsWhenSelectionClears.spec.js",
    "tests/spec/admin/F09-TP2-004_ManualOverridesPreserveSupplier.spec.js",
    "tests/spec/admin/F09-TP2-006_SupplierSelectPrefills.spec.js",
    "tests/spec/admin/F09-TP2-007_SupplierSelectionRequired.spec.js",
    "tests/unit/admin/F09-TP2-001_FormatPriceHint.test.js",
    "codex_output/reports/F09-TP2_green.txt",
    "codex_output/specs/F09-TP2.json"
  ],
  "changeNotes": [
    "Hooked salesLineItems into salesLineHints so supplier, purchase, and last-sold context panes hydrate on selection, clear on reset, and never mutate the stored supplier snapshot.",
    "Implemented salesLineHints helpers (render + formatPriceHint) and wired them to use the shared formatCurrency fallback for ₹ amounts and Not set fallbacks.",
    "Expanded the sales line draft with a required supplier dropdown: the book’s supplier auto-selects, admins can override via the dropdown, clearing it disables Add line with inline messaging, and persisted payloads now carry the chosen supplier snapshot."
  ],
  "notes": "F09-TP2 layers on top of F09-TP1/F08-TP2 by showing immediate supplier + pricing context when a title is chosen. Hints must reflect historical data, clear when the selection is removed, and leave the underlying supplier snapshot untouched so persistence remains reliable."
}
