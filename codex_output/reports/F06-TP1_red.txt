
> test
> cross-env NODE_OPTIONS=--experimental-vm-modules jest --watchAll=false

(node:8963) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL tests/spec/admin/F06-TP1-001_AddFormShowsMultiSupplierControl.spec.js
  SPEC F06-TP1-001: Add form supports multi-supplier selection
    ✕ Add Book form contains a multi-select supplier control (59 ms)

  ● SPEC F06-TP1-001: Add form supports multi-supplier selection › Add Book form contains a multi-select supplier control

    expect(received).not.toBeNull()

    Received: null

      12 |     const multiSelect = dom.querySelector('select[name="supplierIds"]');
      13 |
    > 14 |     expect(multiSelect).not.toBeNull();
         |                             ^
      15 |     expect(multiSelect?.hasAttribute('multiple')).toBe(true);
      16 |     const placeholder = multiSelect?.querySelector('option[disabled]');
      17 |     expect((placeholder?.textContent || '').toLowerCase()).toContain('supplier');

      at Object.<anonymous> (tests/spec/admin/F06-TP1-001_AddFormShowsMultiSupplierControl.spec.js:14:29)

(node:8965) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:8964) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:8969) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:8968) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
(node:8966) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
PASS tests/spec/admin/F06-TP1-002_RequireAtLeastOneSupplier.spec.js
  SPEC F06-TP1-002: Require at least one supplier on add
    ✓ submitting with zero suppliers selected blocks submission (65 ms)

(node:8967) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
PASS tests/spec/admin/TP1-004_BlocksNegativePurchasePrice.spec.js
  SPEC TP1-004: Validation against negative purchase price
    ✓ stops the submission when the value is below zero (68 ms)

PASS tests/spec/admin/F05-TP3-004_HandlesStaleSupplierSelection.spec.js
  SPEC F05-TP3-004: Handle stale/invalid supplier selections
    ✓ Submitting with a stale supplier id is blocked and surfaces warning (76 ms)

PASS tests/spec/admin/F05-TP3-002_RequiresSupplierSelection.spec.js
  SPEC F05-TP3-002: Supplier selection is required
    ✓ Submitting without a supplier prevents addDoc and shows inline error (71 ms)

FAIL tests/spec/admin/F06-TP1-003_PersistMultipleSuppliers.spec.js
  SPEC F06-TP1-003: Persist multiple suppliers on add
    ✕ payload contains deduplicated supplierIds array (72 ms)

  ● SPEC F06-TP1-003: Persist multiple suppliers on add › payload contains deduplicated supplierIds array

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 0

      10 |     await harness.submitAddForm();
      11 |
    > 12 |     expect(harness.mocks.addDoc).toHaveBeenCalledTimes(1);
         |                                  ^
      13 |     const payload = harness.mocks.addDoc.mock.calls[0][1] || {};
      14 |     expect(payload.supplierIds).toEqual(['sup-1', 'sup-2']);
      15 |   });

      at Object.<anonymous> (tests/spec/admin/F06-TP1-003_PersistMultipleSuppliers.spec.js:12:34)

PASS tests/spec/admin/F06-TP1-004_HandleStaleSupplierSelections.spec.js
  SPEC F06-TP1-004: Handle stale supplier selections
    ✓ stale supplier selections prevent submission and reset (76 ms)

PASS tests/spec/admin/F05-TP3-003_PersistsSupplierReference.spec.js
  SPEC F05-TP3-003: Persist supplier reference on add
    ✓ Valid submission includes supplierId in the Firestore payload (60 ms)

PASS tests/spec/admin/TP2-004_PersistsPurchasePriceUpdate.spec.js
  SPEC TP2-004: Persist edited purchase price
    ✓ sends numeric purchasePrice in the updateDoc payload when save succeeds (19 ms)

PASS tests/spec/admin/TP1-002_PersistsPurchasePrice.spec.js
  SPEC TP1-002: Persist purchase price
    ✓ includes purchasePrice number in the addDoc payload (74 ms)

PASS tests/spec/admin/TP1-003_BlocksNonNumericPurchasePrice.spec.js
  SPEC TP1-003: Validation against non-numeric input
    ✓ prevents addDoc and surfaces an inline error (32 ms)

PASS tests/spec/admin/F05-TP2-004_DeleteSupplierWhenUnused.spec.js
  SPEC F05-TP2-004: Delete supplier when unused
    ✓ delete removes supplier when no books reference it (33 ms)

PASS tests/spec/admin/F05-TP4-004_HandleStaleSupplierDuringEdit.spec.js
  SPEC F05-TP4-004: Handle stale supplier during edit
    ✓ if previously selected supplier disappears, save is blocked and warning shown (84 ms)

PASS tests/spec/admin/F05-TP2-001_InlineEditPrefillsSupplier.spec.js
  SPEC F05-TP2-001: Inline edit pre-fills supplier
    ✓ clicking edit populates the form with supplier values and sets edit mode (86 ms)
    ✓ cancel button exits edit mode and clears hidden id (11 ms)

PASS tests/spec/admin/F05-TP2-003_PreventDeleteWhenInUse.spec.js
  SPEC F05-TP2-003: Prevent deleting suppliers in use
    ✓ delete action checks book references and blocks removal when in use (68 ms)

PASS tests/unit/editor/TP2-004_PersistsPurchasePriceUpdate.test.js
  UNIT TP2-004: Persist purchase price edits to Firestore
    ✓ updateDoc receives purchasePrice as a number when submission passes validation (18 ms)

PASS tests/spec/admin/F05-TP4-003_RequireValidSupplierOnEdit.spec.js
  SPEC F05-TP4-003: Require valid supplier when saving edits
    ✓ empty supplier selection blocks save with inline message (12 ms)

PASS tests/spec/admin/F05-TP1-001_SupplierFormRequiresFields.spec.js
  SPEC F05-TP1-001: Supplier form requires name/location
    ✓ missing name blocks submission and surfaces inline error (22 ms)

PASS tests/spec/admin/TP2-003_RejectsNegativePurchasePrice.spec.js
  SPEC TP2-003: Reject negative purchase price on edit
    ✓ prevents update when a negative purchase price is submitted (13 ms)

PASS tests/unit/editor/TP2-002_RejectsNonNumericPurchasePrice.test.js
  UNIT TP2-002: Validate numeric purchase price on edit save
    ✓ non-numeric input keeps dialog open and skips updateDoc (37 ms)

PASS tests/unit/editor/TP2-001_EditFormShowsPurchasePrice.test.js
  UNIT TP2-001: Edit form mirrors existing purchase price
    ✓ open() copies stored purchasePrice (including zero) into the field value (12 ms)

PASS tests/spec/admin/F05-TP2-002_PersistSupplierEdit.spec.js
  SPEC F05-TP2-002: Persist supplier edits
    ✓ submitting in edit mode calls updateDoc with trimmed values (76 ms)
    ✓ duplicate name during edit is blocked with inline message (35 ms)

PASS tests/unit/editor/TP2-003_RejectsNegativePurchasePrice.test.js
  UNIT TP2-003: Prevent negative purchase price submissions
    ✓ negative numbers trigger an inline error and avoid updateDoc (22 ms)

PASS tests/spec/admin/F05-TP4-002_PersistSupplierChange.spec.js
  SPEC F05-TP4-002: Persist supplier change from edit dialog
    ✓ submitting edit with a different supplier updates Firestore payload (41 ms)

PASS tests/spec/admin/F05-TP1-004_RenderNewSupplierInList.spec.js
  SPEC F05-TP1-004: Render supplier list
    ✓ renders suppliers sorted alphabetically with name and location (13 ms)

PASS tests/spec/admin/F05-TP1-003_PersistSupplierRecord.spec.js
  SPEC F05-TP1-003: Persist supplier record
    ✓ valid submission calls addDoc with trimmed payload and resets form (16 ms)

PASS tests/spec/admin/TP2-001_EditFormShowsPurchasePrice.spec.js
  SPEC TP2-001: Edit form exposes purchase price field
    ✓ pre-fills purchase price input with stored value when opening edit dialog (17 ms)

PASS tests/spec/admin/F05-TP1-002_RejectDuplicateSupplierNames.spec.js
  SPEC F05-TP1-002: Reject duplicate supplier names
    ✓ duplicate names (case-insensitive) are blocked with warning (18 ms)

PASS tests/spec/admin/TP2-002_RejectsNonNumericPurchasePrice.spec.js
  SPEC TP2-002: Reject non-numeric purchase price on edit
    ✓ blocks save and surfaces numeric guidance when value contains letters (52 ms)

PASS tests/spec/admin/F05-TP4-001_EditDialogShowsSupplierSelect.spec.js
  SPEC F05-TP4-001: Edit dialog supplier select
    ✓ Edit Book dialog contains supplier dropdown with placeholder (36 ms)

PASS tests/unit/inventory/TP3-004_PurchasePriceFormatting.test.js
  UNIT TP3-004: Purchase price formatting helper
    ✓ text uses ₹ prefix with comma separators (16 ms)

PASS tests/spec/admin/TP3-004_FormatsPurchasePrice.spec.js
  SPEC TP3-004: Purchase price formatting
    ✓ applies rupee prefix and thousand separators (12 ms)

PASS tests/unit/suppliers/F05-TP1-001_NormalizeSupplierName.test.js
  UNIT F05-TP1 helpers
    ✓ normalizeSupplierName trims whitespace and collapses gaps (1 ms)
    ✓ isDuplicateSupplierName compares case-insensitively
    ✓ formatSupplierDisplay returns readable string (1 ms)
    ✓ buildSupplierPayload trims inputs and adds timestamps

PASS tests/unit/public/TP4-004_CatalogPayloadStripsPurchasePrice.test.js
  UNIT TP4-004: Catalog payload strips purchase price
    ✓ subscribeToAllAvailable removes purchasePrice before invoking callback (3 ms)

PASS tests/spec/admin/TP3-002_SoldRowShowsPurchasePrice.spec.js
  SPEC TP3-002: Sold list also shows purchase price
    ✓ sold rows mirror the purchase price label (12 ms)

PASS tests/spec/admin/TP3-001_AvailableRowShowsPurchasePrice.spec.js
  SPEC TP3-001: Available list shows purchase price
    ✓ renders purchase price text with rupee value for available rows (17 ms)

PASS tests/unit/inventory/TP3-003_PurchasePricePlaceholder.test.js
  UNIT TP3-003: Placeholder for missing purchase price
    ✓ renders descriptive placeholder text inside .purchase-price (24 ms)

PASS tests/spec/public/TP4-002_SearchResultsHidePurchasePrice.spec.js
  SPEC TP4-002: Search results hide purchase price
    ✓ filtered render never mentions purchase price even when sale price is shown (7 ms)

PASS tests/spec/public/TP4-003_PurchaseMessageHidesPurchasePrice.spec.js
  SPEC TP4-003: WhatsApp message hides purchase price
    ✓ purchaseMessage ignores purchasePrice field entirely (1 ms)

PASS tests/spec/admin/TP3-003_ShowsPlaceholderWhenMissing.spec.js
  SPEC TP3-003: Placeholder when purchase price missing
    ✓ renders “Purchase price: not set” when value absent (14 ms)

PASS tests/unit/inventory/TP3-001_PurchasePriceElement.test.js
  UNIT TP3-001: Purchase price element exists for available rows
    ✓ available row contains .purchase-price element with rupee value (11 ms)

PASS tests/unit/inventory/TP3-002_SoldPurchasePriceElement.test.js
  UNIT TP3-002: Sold rows keep purchase price element
    ✓ sold list row includes .purchase-price with rupee amount (15 ms)

PASS tests/spec/admin/TP1-001_AddFormShowsPurchasePrice.spec.js
  SPEC TP1-001: Purchase price field is visible
    ✓ add book form includes a numeric purchase price input (27 ms)

PASS tests/spec/admin/F05-TP3-001_PopulatesSupplierDropdown.spec.js
  SPEC F05-TP3-001: Supplier dropdown is present
    ✓ Add Book form contains a supplier select with a placeholder option (38 ms)

PASS tests/spec/public/TP4-001_CatalogCardsHidePurchasePrice.spec.js
  SPEC TP4-001: Catalog cards hide purchase price
    ✓ rendered cards omit any purchase price labels or values (3 ms)

--------------|---------|----------|---------|---------|--------------------------------------------------------------------------------
File          | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                              
--------------|---------|----------|---------|---------|--------------------------------------------------------------------------------
All files     |   44.48 |    32.91 |   44.07 |   46.23 |                                                                                
 auth.js      |       0 |        0 |       0 |       0 | 24-79                                                                          
 autoPrice.js |       0 |        0 |       0 |       0 | 2-25                                                                           
 currency.js  |     100 |     64.7 |     100 |     100 | 5,7,12,17-24,30                                                                
 editor.js    |   70.79 |    68.24 |   73.07 |   72.55 | 46-47,53,93,122-151,155,185,192,199,339,353-371,378-395                        
 inventory.js |    71.5 |    49.06 |   69.69 |   71.73 | 59,66-68,118-168,190,212,246-249,323-327,342-343,357,360,410-411,417-419       
 lookup.js    |       0 |        0 |       0 |       0 | 11-483                                                                         
 main.js      |       0 |        0 |       0 |       0 | 28-246                                                                         
 requests.js  |       0 |        0 |       0 |       0 | 6-73                                                                           
 suppliers.js |   81.64 |    57.37 |   85.18 |   86.48 | 15,116-117,136-138,149-151,177-178,190-191,221-224,254-258,267,273-274,295-302 
--------------|---------|----------|---------|---------|--------------------------------------------------------------------------------
Summary of all failing tests
FAIL tests/spec/admin/F06-TP1-001_AddFormShowsMultiSupplierControl.spec.js
  ● SPEC F06-TP1-001: Add form supports multi-supplier selection › Add Book form contains a multi-select supplier control

    expect(received).not.toBeNull()

    Received: null

      12 |     const multiSelect = dom.querySelector('select[name="supplierIds"]');
      13 |
    > 14 |     expect(multiSelect).not.toBeNull();
         |                             ^
      15 |     expect(multiSelect?.hasAttribute('multiple')).toBe(true);
      16 |     const placeholder = multiSelect?.querySelector('option[disabled]');
      17 |     expect((placeholder?.textContent || '').toLowerCase()).toContain('supplier');

      at Object.<anonymous> (tests/spec/admin/F06-TP1-001_AddFormShowsMultiSupplierControl.spec.js:14:29)

FAIL tests/spec/admin/F06-TP1-003_PersistMultipleSuppliers.spec.js
  ● SPEC F06-TP1-003: Persist multiple suppliers on add › payload contains deduplicated supplierIds array

    expect(jest.fn()).toHaveBeenCalledTimes(expected)

    Expected number of calls: 1
    Received number of calls: 0

      10 |     await harness.submitAddForm();
      11 |
    > 12 |     expect(harness.mocks.addDoc).toHaveBeenCalledTimes(1);
         |                                  ^
      13 |     const payload = harness.mocks.addDoc.mock.calls[0][1] || {};
      14 |     expect(payload.supplierIds).toEqual(['sup-1', 'sup-2']);
      15 |   });

      at Object.<anonymous> (tests/spec/admin/F06-TP1-003_PersistMultipleSuppliers.spec.js:12:34)


Test Suites: 2 failed, 43 passed, 45 total
Tests:       2 failed, 48 passed, 50 total
Snapshots:   0 total
Time:        2.393 s
Ran all test suites.
